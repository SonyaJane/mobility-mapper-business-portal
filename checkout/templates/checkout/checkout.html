{% extends "base.html" %}
{% load static %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'checkout/css/checkout.css' %}">
{% endblock %}

{% block content %}
<div class="container">
  <h2 class="my-4">Checkout</h2>


  {% if form.errors %}
    <div class="alert alert-danger">
      <strong>Please correct the errors below:</strong>
      <ul>
        {% for field in form %}
          {% for error in field.errors %}
            <li>{{ error }}</li>
          {% endfor %}
        {% endfor %}
        {% for error in form.non_field_errors %}
          <li>{{ error }}</li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}

  <!-- Order Summary -->
  <div class="order-summary my-4 border p-3">
    <h4 class="mb-4">Order Summary</h4>
    <p class="d-flex align-items-center">
      <strong>Pricing Tier:</strong>
      <span id="summary-tier-display" class="ms-2">{{ business.pricing_tier.get_tier_display }}</span>
      <button type="button" id="change-tier-btn" class="btn btn-sm btn-green-outline ms-3">Change Tier</button>
    </p>
    <!-- Hidden tier selection panel -->
    <div id="checkout-tier-options" class="row g-3 mb-4" style="display: none;">
      {% for tier in pricing_tiers %}
        <div class="col-md-6 p-0-custom">
            <div class="card mb-3 pricing-tier-card h-100"
                data-tier-code="{{ tier.tier }}"
                data-tier-display="{{ tier.get_tier_display }}"
                data-tier-month="{{ tier.price_per_month|floatformat:2 }}"
                data-tier-year="{{ tier.price_per_year|default_if_none:0|floatformat:2 }}"
                tabindex="0" style="cursor:pointer;">
                <div class="card-body d-flex flex-column">
                <h5 class="card-title">{{ tier.get_tier_display }}</h5>
                {% if tier.description %}
                <ul class="card-text ps-3 ms-0 mb-3">
                    {% for line in tier.description.splitlines %}
                    <li>{{ line }}</li>
                    {% endfor %}
                </ul>
                {% endif %}
                <p class="mt-auto"><strong>£{{ tier.price_per_month }} / month</strong>{% if tier.price_per_year %} or £{{ tier.price_per_year }} / year{% endif %}</p>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
    <p class="d-flex align-items-center">
      <strong>Billing Frequency:</strong>
      <span id="summary-frequency-display" class="ms-2">{{ business.get_billing_frequency_display }}</span>
      <button type="button" id="change-frequency-btn" class="btn btn-sm btn-green-outline ms-3">Change Frequency</button>
    </p>
    <!-- Hidden frequency selection panel -->
    <div id="checkout-frequency-options" class="btn-group mb-4 d-none">
      {% for value,label in form.fields.interval.choices %}
        {% if value %}
          <button type="button" class="btn btn-coffee-outline freq-btn {% if form.initial.interval == value %}active{% endif %}" data-freq-value="{{ value }}">{{ label }}</button>
        {% endif %}
      {% endfor %}
    </div>
    <p><strong>Amount:</strong> <span id="summary-amount">
      {% if form.initial.interval == 'yearly' and business.pricing_tier.price_per_year %}
        £{{ business.pricing_tier.price_per_year }} / year
      {% else %}
        £{{ business.pricing_tier.price_per_month }} / month
      {% endif %}
    </span></p>
    <p>Please check your details below are correct:</p>
  </div>
  <form action="" method="post" id="payment-form">
    {% csrf_token %}
    <input type="hidden" name="tier" value="{{ form.initial.tier }}">
    <input type="hidden" name="interval" value="{{ form.initial.interval }}">

    <!-- Contact Information -->
    <fieldset class="mb-4 border p-3">
      <legend class="h4 mb-4">Contact Details</legend>
      {% for field in form.visible_fields %}
        {% if field.name == 'full_name' or field.name == 'email' or field.name == 'phone_number' %}
          {{ field|as_crispy_field }}
        {% endif %}
      {% endfor %}
    </fieldset>

    <!-- Address Information -->
    <fieldset class="mb-4 border p-3">
      <legend class="h4 mb-4">Billing Address</legend>
      {% for field in form.visible_fields %}
        {% if field.name == 'street_address1' or field.name == 'street_address2' or field.name == 'town_or_city' or field.name == 'county' or field.name == 'postcode' %}
          {{ field|as_crispy_field }}
        {% endif %}
      {% endfor %}
    </fieldset>

    <!-- Payment Details -->
    <fieldset class="mb-4 border p-3">
      <legend class="h4 mb-4">Payment Details</legend>
      <!--Stripe card element will be inserted here-->
      <div class="mb-3" id="card-element"></div>
      <!--Display card errors-->
      <div id="card-errors" role="alert" class="text-danger mb-3"></div>
    </fieldset>

    <!-- Charge Warning -->
    <div class="mb-3">
      <p class="small text-orange my-0" id="charge-warning">
        <span class="icon">
          <i class="bi bi-exclamation-circle"></i>
        </span>
        <span>Your card will be charged <strong>£
        {% if form.initial.interval == 'yearly' and business.pricing_tier.price_per_year %}
          {{ business.pricing_tier.price_per_year|floatformat:2 }} per year
        {% else %}
          {{ business.pricing_tier.price_per_month|floatformat:2 }} per month
        {% endif %}
        </strong></span>
      </p>
    </div>

    <!-- Submit & Loading -->
    <button id="submit-button" type="submit" class="btn btn-green">Complete Subscription</button>
    <div id="loading-overlay" class="d-none">
      <div class="spinner-border text-green" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>
    

  </form>
</div>
{% endblock %}

{% block postloadjs %}
    {{ block.super }}
    {{ stripe_publishable_key|json_script:"id_stripe_public_key" }}
    {{ client_secret|json_script:"id_client_secret" }}
    <script src="{% static 'js/checkout.js' %}"></script>
{% endblock %}