{% extends "base.html" %}
{% load crispy_forms_tags %}

{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/wheeler_verification_form.css' %}">
{% endblock %}

{% block page_title %}Accessibility Verification{% endblock %}

{% block content %}
<div class="content-container mw-600 p-2">
  <!-- Client-side error messages -->
  <div class="alert alert-danger d-none" id="client-error-container">
    <ul id="client-error-list" class="mb-0"></ul>
  </div>

  <h4 class="mt-4 mb-1 underline-orange align-self-start">Accessibility Verification</h4>
  <p class="my-3">
    Thank you for agreeing to verify the accessibility features of
    <span class="fw-bold text-orange">{{ business.business_name }}</span>.
  </p>

  <p><strong>Address:</strong> {{ business.street_address1 }}{% if business.street_address2 %}, {{ business.street_address2 }}{% endif %}, {{ business.town_or_city }}{% if business.county %}, {{ business.county }}{% endif %}{% if business.postcode %}, {{ business.postcode }}{% endif %}</p>

  <p>Please complete this form while visiting <span class="fw-bold text-orange">{{ business.business_name }}</span> at the address shown above.</p>

  <p>Your responses will be anonymous and your identity will not be revealed to <span class="fw-bold text-orange">{{ business.business_name }}</span>.</p>

  <form method="POST" enctype="multipart/form-data">
    {% if form.errors %}
      <div class="alert alert-danger">
        <strong>Please correct the errors below:</strong>
        <ul>
        {% for field in form %}
          {% for error in field.errors %}
            {% if field.name == 'categories' or field.name == 'accessibility_features' %}
              <li>
                <strong>{{ field.label }}</strong><br>
                {{ error }}
              </li>
            {% else %}
              <li><strong>{{ field.label }}:</strong> {{ error }}</li>
            {% endif %}
          {% endfor %}
        {% endfor %}
        {% for error in form.non_field_errors %}
          <li>{{ error }}</li>
        {% endfor %}
        </ul>
      </div>
    {% endif %}

    {% csrf_token %}

    <div class="mb-3 border-custom" id="confirmed-features-section">
      <label class="fw-bold p-2">
        <span class="fw-bold text-orange">{{ business.business_name }}</span> has told us the following accessibility features are present on the premises. Please tick those you can confirm and upload a photo.
      </label>
      <table class="table table-striped table-bordered m-0">
        <tbody>
          {% for feature in business.accessibility_features.all %}
          <tr>
            <td class="text-center align-middle w-41">
              <input class="form-check-input" type="checkbox" name="confirmed_features" value="{{ feature.pk }}" id="confirmfeat{{ feature.pk }}" style="width:1.5rem; height:1.5rem;" {% if feature.pk|stringformat:"s" in form.confirmed_features.value %}checked{% endif %}>
            </td>
            <td class="align-middle">
              <label class="form-check-label" for="confirmfeat{{ feature.pk }}">{{ feature.name }}</label>
            </td>
            <td class="text-center align-middle w-49">
              <div class="feature-photo-wrapper" data-feature="{{ feature.pk }}">
                <button type="button" class="btn btn-orange-outline btn-sm feature-photo-btn" data-feature="{{ feature.pk }}">
                  <i class="bi bi-camera"></i>
                </button>
                <input type="file" name="feature_photo_{{ feature.pk }}" accept="image/*" class="feature-photo-input d-none" data-feature="{{ feature.pk }}">
                <span class="feature-photo-status d-none" data-feature="{{ feature.pk }}">
                  <img src="#" alt="Preview" class="feature-photo-preview img-thumbnail me-2 d-none" data-feature="{{ feature.pk }}">
                  <a href="#" class="remove-photo text-danger" data-feature="{{ feature.pk }}">delete</a>
                </span>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="mb-3 border-custom" id="additional-features-section">
      <label class="fw-bold p-2">
        Can you see any of the additional accessibility features listed below? Please tick those you can see and upload a photo.
      </label>
      <table class="table table-striped table-bordered m-0">
        <tbody>
          {% for feature in form.fields.additional_features.queryset %}
          <tr>
            <td class="text-center align-middle w-41">
              <input class="form-check-input" type="checkbox" name="additional_features" value="{{ feature.pk }}" id="addfeat{{ feature.pk }}" style="width:1.5rem; height:1.5rem;" {% if feature.pk|stringformat:"s" in form.additional_features.value %}checked{% endif %}>
            </td>
            <td class="align-middle">
              <label class="form-check-label" for="addfeat{{ feature.pk }}">{{ feature.name }}</label>
            </td>
            <td class="text-center align-middle w-49">
              <div class="feature-photo-wrapper" data-feature="{{ feature.pk }}">
                <button type="button" class="btn btn-orange-outline btn-sm feature-photo-btn" data-feature="{{ feature.pk }}">
                  <i class="bi bi-camera"></i>
                </button>
                <input type="file" name="feature_photo_{{ feature.pk }}" accept="image/*" class="feature-photo-input d-none" data-feature="{{ feature.pk }}">
                <span class="feature-photo-status d-none" data-feature="{{ feature.pk }}">
                  <img src="#" alt="Preview" class="feature-photo-preview img-thumbnail me-2 d-none" data-feature="{{ feature.pk }}">
                  <a href="#" class="remove-photo text-danger" data-feature="{{ feature.pk }}">delete</a>
                </span>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="mb-3 border-custom" id="mobility-device-section">
      <label class="fw-bold p-2">
        Select the mobility device you are using at <span class="fw-bold text-orange">{{ business.business_name }}</span>:
      </label>
      <table class="table table-striped table-bordered m-0">
        <tbody>
          {% for device in devices %}
          <tr>
            <td>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="mobility_device" value="{{ device.pk }}" id="mobdev{{ device.pk }}" style="width:1.5rem; height:1.5rem;">
                <label class="form-check-label" for="mobdev{{ device.pk }}">{{ device.name }}</label>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Selfie upload -->
    <div class="mb-3 border-custom" id="selfie-section">
      <label class="fw-bold p-2">Upload a photo of yourself at <span class="fw-bold text-orange">{{ business.business_name }}</span>. 
        This will help us verify that you were there.</label>
      <div class="p-1">
        <input type="file" name="selfie" accept="image/*" class="form-control" required>
      </div>
    </div>

    <div class="mb-3 border-custom">
      <div class="fw-bold p-2">Please upload any additional photos you took at <span class="fw-bold text-orange">{{ business.business_name }}</span> that you have not already uploaded:</div>
      <div class="p-1">
        <input type="file" name="photos" multiple class="form-control">
      </div>
    </div>

    <div class="mb-3 border-custom">
      <label class="fw-bold p-2">
        Please write a few sentences about your accessibility experience while visiting this business.
      </label>
      <div class="w-100 p-1">
        {{ form.comments }}
      </div>
    </div>
    
    <button type="submit" class="btn btn-green">Submit Verification</button>
  </form>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/wheeler_verification_form.js' %}"></script>
{% endblock %}