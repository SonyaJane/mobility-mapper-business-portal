{% extends "base.html" %}
{% load crispy_forms_tags %}

{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/wheeler_verification_form.css' %}">
{% endblock %}

{% block page_title %}Accessibility Verification{% endblock %}

{% block content %}
<div class="content-container p-2">

  <h4 class="my-3 text-center">
    <span class="d-block">Verification of the accessibility features of</span>
    <span class="fw-bold text-primary py-2 d-block">{{ business.business_name }}</span>
    <span class="d-block">by</span>
    <span class="fw-bold text-primary py-2 d-block">{{ request.user.get_full_name }}</span>
  </h4>

  <p><strong>Address:</strong> {{ business.address }}</p>

  <p>Please complete this form while visiting the business.</p>

  <p>Your responses will be anonymous and your identity will not be revealed to the business.</p>

  <form method="POST" enctype="multipart/form-data">
    {% if form.errors %}
      <div class="alert alert-danger">
        <strong>Please correct the errors below:</strong>
        <ul>
        {% for field in form %}
          {% for error in field.errors %}
            {% if field.name == 'categories' or field.name == 'accessibility_features' %}
              <li>
                <strong>{{ field.label }}</strong><br>
                {{ error }}
              </li>
            {% else %}
              <li><strong>{{ field.label }}:</strong> {{ error }}</li>
            {% endif %}
          {% endfor %}
        {% endfor %}
        {% for error in form.non_field_errors %}
          <li>{{ error }}</li>
        {% endfor %}
        </ul>
      </div>
    {% endif %}

    {% csrf_token %}

    <div class="mb-3 border-custom">
      <label class="fw-bold p-2">
        Below is a list of accessibility features the business has specified are present on the premises. Select those you confirm.
      </label>
      <table class="table table-striped table-bordered m-0">
        <tbody>
          {% for feature in business.accessibility_features.all %}
          <tr>
            <td class="text-center align-middle">
              <input class="form-check-input" type="checkbox"
                     name="confirmed_features"
                     value="{{ feature.pk }}"
                     id="confirmfeat{{ feature.pk }}"
                     style="width:1.5rem; height:1.5rem;">
            </td>
            <td class="align-middle">
              <label class="form-check-label" for="confirmfeat{{ feature.pk }}">{{ feature.name }}</label>
            </td>
            <td class="text-center align-middle">
              <div class="feature-photo-wrapper" data-feature="{{ feature.pk }}">
                <button type="button" class="btn btn-secondary btn-sm feature-photo-btn" data-feature="{{ feature.pk }}">
                  Upload Photo
                </button>
                <input type="file"
                       name="feature_photo_{{ feature.pk }}"
                       accept="image/*"
                       class="feature-photo-input invisible"
                       style="width:1px; height:1px;"
                       data-feature="{{ feature.pk }}">
                <span class="feature-photo-status text-success d-none" data-feature="{{ feature.pk }}">
                  Photo uploaded <a href="#" class="remove-photo text-danger ms-2" data-feature="{{ feature.pk }}">×</a>
                </span>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="mb-3 border-custom">
      <label class="fw-bold p-2">
        Below is a list of accessibility features the business has NOT specified as present. Select any you found during your visit.
      </label>
      <table class="table table-striped table-bordered m-0">
        <tbody>
          {% for feature in form.fields.additional_features.queryset %}
          <tr>
            <td class="text-center align-middle">
              <input class="form-check-input" type="checkbox"
                     name="additional_features"
                     value="{{ feature.pk }}"
                     id="addfeat{{ feature.pk }}"
                     style="width:1.5rem; height:1.5rem;">
            </td>
            <td class="align-middle">
              <label class="form-check-label" for="addfeat{{ feature.pk }}">{{ feature.name }}</label>
            </td>
            <td class="text-center align-middle">
              <div class="feature-photo-wrapper" data-feature="{{ feature.pk }}">
                <button type="button" class="btn btn-secondary btn-sm feature-photo-btn" data-feature="{{ feature.pk }}">
                  Upload Photo
                </button>
                <input type="file"
                       name="feature_photo_{{ feature.pk }}"
                       accept="image/*"
                       class="feature-photo-input invisible"
                       style="width:1px; height:1px;"
                       data-feature="{{ feature.pk }}">
                <span class="feature-photo-status text-success d-none" data-feature="{{ feature.pk }}">
                  Photo uploaded <a href="#" class="remove-photo text-danger ms-2" data-feature="{{ feature.pk }}">×</a>
                </span>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="mb-3 border-custom">
      <label class="fw-bold p-2">
        Select the mobility device you used during your visit:
      </label>
      <table class="table table-striped table-bordered m-0">
        <tbody>
          {% for code, device_label in request.user.userprofile.MOBILITY_DEVICE_CHOICES %}
          <tr>
            <td>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="mobility_device" value="{{ code }}" id="mobdev{{ code }}" style="width:1.5rem; height:1.5rem;">
                <label class="form-check-label" for="mobdev{{ code }}">{{ device_label }}</label>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="mb-3 border-custom">
      <div class="fw-bold p-2">Photos</div>
      <div>
        <input type="file" name="photos" multiple class="form-control">
        <small class="form-text text-muted">Upload one or more photos.</small>
      </div>
    </div>

    <div class="mb-3 border-custom">
      <label class="fw-bold p-2">
        Please write a few sentences about your accessibility experience while visiting this business.
      </label>
      <div class="w-100">
        {{ form.comments }}
      </div>
    </div>
    
    <button type="submit" class="btn btn-success">Submit Verification</button>
  </form>
</div>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.feature-photo-wrapper').forEach(wrapper => {
      const btn = wrapper.querySelector('.feature-photo-btn');
      const input = wrapper.querySelector('.feature-photo-input');
      const status = wrapper.querySelector('.feature-photo-status');
      const removeLink = wrapper.querySelector('.remove-photo');
      btn.addEventListener('click', () => input.click());
      input.addEventListener('change', () => {
        if (input.files.length) {
          btn.classList.add('d-none');
          status.classList.remove('d-none');
        }
      });
      removeLink.addEventListener('click', e => {
        e.preventDefault();
        input.value = '';
        status.classList.add('d-none');
        btn.classList.remove('d-none');
      });
    });
  });
</script>
{% endblock %}
