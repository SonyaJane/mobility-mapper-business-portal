{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/edit_business.css' %}">
{% endblock %}

{% block page_title %}Edit Business{% endblock %}

{% block content %}

<div class="content-container p-3">
  <h4 class="mb-2">Edit your business</h4>
  <p class="mt-1">The details you enter below will appear in the public search results on the <a href="{% url 'accessible_business_search' %}" class="link-body-emphasis">Search for Accessible Businesses</a> page. Therefore, the more complete and accurate your listing, the better potential customers can find and choose your business.</p>

  <form method="POST" enctype="multipart/form-data" class="business-registration-form">
    {% if form.errors %}
      <div class="alert alert-danger">
        <strong>Please correct the errors below:</strong>
        <ul>
        {% for field in form %}
          {% for error in field.errors %}
            {% if field.name == 'categories' or field.name == 'accessibility_features' %}
              <li>
                <strong>{{ field.label }}</strong><br>
                {{ error }}
              </li>
            {% else %}
              <li><strong>{{ field.label }}:</strong> {{ error }}</li>
            {% endif %}
          {% endfor %}
        {% endfor %}
        {% for error in form.non_field_errors %}
          <li>{{ error }}</li>
        {% endfor %}
        </ul>
      </div>
    {% endif %}

    {% csrf_token %}
    {{ form.media }}

    <!-- Other Form Fields -->
    {% for field in form.visible_fields %}
      {% if field.name != 'categories' and field.name != 'other_category' and field.name != 'accessibility_features' and field.name != 'pricing_tier' and field.name != 'billing_frequency' and field.name != 'opening_hours' and field.name != 'special_offers' %}
        {{ field|as_crispy_field }}
      {% endif %}
    {% endfor %}

    <!-- Categories (grouped multi-select dropdown) -->
    <div class="mb-3">
      <label for="id_categories" class="form-label">
        Business Categories*
        <br>
        <small>Select the categories that describe your business. If yours isn't listed, choose 'Other' and enter it below.</small>
      </label>
      {% regroup form.fields.categories.queryset by group_description as grouped_categories %}
      {% with selected=selected_categories %}
      <select name="categories" id="id_categories" class="form-select" multiple size="8">
        {% for group in grouped_categories %}
          {% if group.grouper %}
          <optgroup label="{{ group.grouper }}">
            {% for category in group.list %}
              <option value="{{ category.pk }}" {% if category.pk|stringformat:'s' in selected %}selected{% endif %}>{{ category.name }}</option>
            {% endfor %}
          </optgroup>
          {% endif %}
        {% endfor %}
        <optgroup label="Other">
          {# include categories with no group_description #}
          {% for group in grouped_categories %}
            {% if not group.grouper %}
              {% for category in group.list %}
                <option value="{{ category.pk }}" {% if category.pk|stringformat:'s' in selected %}selected{% endif %}>{{ category.name }}</option>
              {% endfor %}
            {% endif %}
          {% endfor %}
          <option value="__other__" {% if '__other__' in selected %}selected{% endif %}>Other</option>
        </optgroup>
        </select>
      {% endwith %}
      <div id="other-category-field" class="my-3" style="display: none;">
        {{ form.other_category|as_crispy_field }}
      </div>
    </div>

    <!-- Accessibility Features (flat multi-select dropdown) -->
    <div class="mb-3">
      <label for="id_accessibility_features" class="form-label">Accessibility Features</label>
      <select name="accessibility_features" id="id_accessibility_features" class="form-select" multiple size="8">
        {% for code, name in form.fields.accessibility_features.choices %}
          <option value="{{ code }}" {% if code|stringformat:'s' in selected_accessibility_features %}selected{% endif %}>{{ name }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- Opening Hours Widget -->
    <div class="mb-3">
      <label class="form-label">
        Business Hours<br>
        <small class="form-text text-muted">Set opening and closing times for each day, or mark as closed.</small>
      </label>
      <input type="hidden" name="opening_hours" id="id_opening_hours" value="{{ form.opening_hours.value|default:'' }}">
      <table class="table table-bordered" id="opening-hours-table">
        <thead>
          <tr><th>Day</th><th>Periods</th><th>Closed</th></tr>
        </thead>
        <tbody>
          {% for day in days_of_week %}
          <tr data-day="{{ day }}">
            <td>{{ day }}</td>
            <td>
              <div class="periods-container"></div>
              <button type="button" class="btn btn-sm btn-outline-secondary add-period-btn" data-day="{{ day }}">Add period</button>
              <button type="button" class="btn btn-sm btn-outline-primary copy-down-btn" data-day="{{ day }}">Copy to next day</button>
            </td>
            <td><input type="checkbox" class="closed-checkbox" data-day="{{ day }}"></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Special Offers -->
    <div class="mb-3">
      <label for="id_special_offers" class="form-label">
        Special Offers for Wheelers<br>
        <small class="form-text text-muted">Add any discounts or promotions specifically for Wheelers to encourage customers to come to your business.</small><br>
      </label>
      {{ form.special_offers }}
    </div>

    <!-- Hidden Pricing Tier and Billing Frequency fields -->
    {% if form.pricing_tier %}
      {{ form.pricing_tier.as_hidden }}
    {% endif %}
    {% if form.billing_frequency %}
      {{ form.billing_frequency.as_hidden }}
    {% endif %}

    <button type="submit" class="btn btn-success">Save Changes</button>
    <a href="{% url 'business_dashboard' %}" class="btn btn-secondary">Cancel</a>

    <!-- Delete Business Button -->
    <button type="button" class="btn btn-danger float-end ms-2" data-bs-toggle="modal" data-bs-target="#deleteBusinessModal">
      Delete Business
    </button>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteBusinessModal" tabindex="-1" aria-labelledby="deleteBusinessModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="deleteBusinessModalLabel">Confirm Delete</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            Are you sure you want to delete this business? This action cannot be undone.
          </div>
          <div class="modal-footer">
            <form method="post" action="{% url 'delete_business' %}">
              {% csrf_token %}
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-danger">Delete</button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </form>
</div>
{% endblock %}

{% block extra_js %}
<script type="module" src="{% static 'js/edit_business.js' %}"></script>
{% endblock %}