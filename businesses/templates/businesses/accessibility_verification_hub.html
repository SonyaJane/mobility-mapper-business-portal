{% extends "base.html" %}
{% load dict_extras %}
{% block content %}
<div class="content-container m-1">
  <div class="p-2">

    <h3 class="my-3 underline-orange align-self-start">Accessibility Verification Hub</h3>
    {% if requests %}
    <p class="mb-3">Welcome to the Accessibility Verification Hub, where you can manage your accessibility verification applications and reports.</p>
    <div class="table-responsive h-100 w-100" style="overflow:auto;">
      <table class="table table-bordered">
        <thead>
          <tr>
            <th class="align-middle text-nowrap">Business</th>
            <th class="align-middle text-nowrap">Request Status</th>
            <th class="align-middle text-nowrap">Date Requested</th>
            <th class="align-middle text-nowrap">Date Request Approved</th>
            <th class="align-middle text-nowrap">Verification Report Status</th>
            <th class="align-middle text-nowrap">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for req in requests %}
          <tr>
            <td>{{ req.business.business_name }}</td>
            <td>
              {% if req.approved %}
                <span class="badge bg-success">Approved</span>
              {% elif req.reviewed %}
                <span class="badge bg-danger">Rejected</span>
              {% else %}
                <span class="badge bg-warning text-dark">Submitted</span>
              {% endif %}
            </td>
            <td>{{ req.requested_at|date:"F j, Y" }}</td>
            <td>
              {% if req.approved_at %}
                {{ req.approved_at|date:"F j, Y" }}
              {% else %}
                <span class="text-muted">Waiting for approval</span>
              {% endif %}
            </td>
            <td>
              {% with submitted=verification_status|get_item:req.id approved=verification_approved|get_item:req.id %}
                {% if req.approved and submitted and approved %}
                  <span class="badge bg-success">Approved</span>
                {% elif req.approved and submitted %}
                  <span class="badge bg-info">Submitted</span>
                {% elif req.approved %}
                  <span class="badge bg-secondary">Not Submitted</span>
                {% endif %}
              {% endwith %}
            </td>
            <td>
              {% with submitted=verification_status|get_item:req.id %}
                {% if submitted %}
                  <a href="{% url 'verification_report' verification_id_map|get_item:req.id %}" class="btn btn-sm btn-green-outline">View Report</a>
                {% elif req.approved %}
                  <a href="{% url 'wheeler_verification_form' req.business.id %}" class="btn btn-sm btn-green">Submit Verification</a>
                {% else %}
                  <button type="button" class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#cancelModal-{{ req.id }}">
                    Cancel Request
                  </button>
                {% endif %}
              {% endwith %}
            </td>
          </tr>
          <!-- Cancel Confirmation Modal -->
          <div class="modal fade" id="cancelModal-{{ req.id }}" tabindex="-1" aria-labelledby="cancelModalLabel-{{ req.id }}" aria-hidden="true">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="cancelModalLabel-{{ req.id }}">Cancel Verification Request</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  Are you sure you want to cancel your request to verify {{ req.business.business_name }}?
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No, Keep It</button>
                  <a href="{% url 'cancel_wheeler_verification_request' req.business.id %}" class="btn btn-danger">Yes, Cancel</a>
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <p class="alert alert-info">You have not made any verification requests yet.</p>
  {% endif %}
  </div>
</div>
{% endblock %}
