{% extends "base.html" %}
{% load static account_extras %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/account_dashboard.css' %}">
{% endblock %}

{% block page_title %}Personal Dashboard{% endblock %}

{% block content %}
<div class="content-container mx-1">

  <!-- Dashboard Header -->
  {% if user.userprofile.photo %}
  <div class="row align-items-center my-4 gy-4 gx-2">
    <div class="col-md-4 text-center">
      <img src="{{ profile_photo }}" alt="Profile Photo" class="img-fluid rounded" style="max-height: 180px; aspect-ratio: 1/1; object-fit: cover;">
    </div>
    <div class="col-md-8 text-center">
  {% else %}
  <div class="text-center mt-4">
  {% endif %}
      <h1 class="fw-bold">{{ user.first_name }} {{ user.last_name }}</h1>
      <p class="fs-5 text-muted">Dashboard</p>
    </div>
  </div>

  <div class="row mb-3 g-3">
    <!-- Profile Details Card -->
    <div class="col-md-8">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h5 class="card-title mb-3">Profile Details</h5>
          <div class="table-responsive">
            <table id="profile-details" class="table table-sm table-striped table-hover mb-0">
              <tbody>
                <tr>
                  <td class="align-middle ps-3"><i class="bi bi-person-circle fs-5 me-2 text-mango"></i><strong>Username:</strong></td>
                  <td class="align-middle">{{ user.username }}</td>
                </tr>
                <tr>
                  <td class="align-middle ps-3"><i class="bi bi-envelope fs-5 me-2 text-orange"></i><strong>Email Address:</strong></td>
                  <td class="align-middle">{{ user.email }}</td>
                </tr>
                {% if user.userprofile.county %}
                <tr>
                  <td class="align-middle ps-3"><i class="bi bi-geo-fill fs-5 me-2 text-brown"></i><strong>County:</strong></td>
                  <td class="align-middle">{{ user.userprofile.county }}</td>
                </tr>
                {% endif %}
                <tr>
                  <td class="align-middle ps-3"><i class="bi bi-globe fs-5 me-2 text-coffee"></i><strong>Country:</strong></td>
                  <td class="align-middle">{{ user.userprofile.country }}</td>
                </tr>
                {% if user.userprofile.age_group %}
                <tr>
                  <td class="align-middle ps-3"><i class="bi bi-person fs-5 me-2 text-mango"></i><strong>Age Group:</strong></td>
                  <td class="align-middle">{{ user.userprofile.get_age_group_display }}</td>
                </tr>
                {% endif %}
                {% if user.userprofile.is_wheeler %}
                <tr>
                  <td class="align-middle ps-3"><i class="bi bi-person-wheelchair fs-5 me-2 text-orange"></i><strong>Mobility Devices:</strong></td>
                  <td class="align-middle">
                    {% with labels=user.userprofile.mobility_devices|device_labels %}
                      {{ labels }}{% if user.userprofile.mobility_devices_other %}, {{ user.userprofile.mobility_devices_other }}{% endif %}
                    {% endwith %}
                  </td>
                </tr>
                {% endif %}
                {% if user.userprofile.has_business and user.userprofile.business %}
                <tr>
                  <td class="align-middle ps-3"><i class="bi bi-building fs-5 me-2 text-brown"></i><strong>Your Business:</strong></td>
                  <td class="align-middle"><a href="{% url 'business_dashboard' %}" class="link-body-emphasis">{{ user.userprofile.business.business_name }}</a></td>
                </tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Account Actions Card -->
    <div class="col-md-4">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h5 class="card-title mb-3">Account Actions</h5>
          <div class="d-flex flex-column gap-2">
            <a href="{% url 'edit_profile' %}" class="btn btn-orange btn-custom-width">Edit Profile</a>
            <a href="{% url 'account_change_password' %}" class="btn btn-mango btn-custom-width">Change Password</a>
            {% if user.userprofile.has_business and not user.userprofile.business %}
              <a href="{% url 'register_business' %}" class="btn btn-green btn-custom-width">Register Your Business</a>
            {% endif %}
            {% if verification_reports or approved_businesses or pending_businesses %}
              <a href="{% url 'wheeler_verification_history' %}" class="btn btn-coffee btn-custom-width">View Your Business Verifications</a>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  {% if user.userprofile.is_wheeler %}
  <div class="row mb-3 g-3">

    <!-- Businesses you are approved to verify -->
    {% with unverified_businesses=approved_businesses|dictsort:"id"|filter_unverified:business_verification_status %}
      {% if unverified_businesses %}
        <div class="col-12">
          <div class="card shadow-sm">
            <div class="card-body">
              <h5 class="card-title mb-3">Businesses you are approved to verify</h5>
              <ul class="list-group">
                {% for business in unverified_businesses %}
                <li class="list-group-item">
=                  <h5 class="mb-1 business text-orange">{{ business.business_name }}</h5>
                  {% if business.categories.all %}
                  <div class="mb-0 category">{{ business.categories.all|join:", " }}</div>
                  {% endif %}
                  <div>{{ business.address }}</div>
                  <div class="mt-2">
                    <a href="{% url 'business_detail' business.id %}" class="btn btn-outline-secondary btn-sm me-2">View Business</a>
                    <a href="{% url 'wheeler_verification_form' business.id %}" class="btn btn-success btn-sm">Start Verification</a>
                  </div>
                </li>
                {% endfor %}
              </ul>
            </div>
          </div>
        </div>
      {% endif %}
    {% endwith %}

    {% if pending_businesses %}
      <div class="col-12">
        <div class="card shadow-sm">
          <div class="card-body">
            <h5 class="card-title mb-3">Businesses you have applied to verify</h5>
            <ul class="list-group">
              {% for business in pending_businesses %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <div>
                    <h5 class="mb-1 business">
                      <a href="{% url 'business_detail' business.id %}" class="text-decoration-none text-orange">{{ business.business_name }}</a>
                    </h5>
                    {% if business.categories.all %}
                    <div class="category text-muted small">{{ business.categories.all|join:", " }}</div>
                    {% endif %}
                    <div class="text-muted small">{{ business.address }}</div>
                  </div>
                  <div>
                    <a href="{% url 'cancel_wheeler_verification_request' business.id %}" class="btn btn-sm btn-orange-outline">Cancel Request</a>
                  </div>
                </li>
              {% endfor %}
            </ul>
            </div>
          </div>
        </div>
    {% endif %}


    <!-- Business Verification Instructions -->
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title mb-3">Wheeler Accessibility Verification</h5>
          <p class="mb-2">As a wheeler, you can help improve accessibility for everyone by verifying the accessibility features of businesses you visit. Your reports help other users find accessible places and encourage businesses to improve their facilities.</p>
          <ul class="mb-2">
            <li>For every report you verify, you will receive a <strong>Â£10 Amazon voucher</strong> as a thank you for your contribution.</li>
            <li>To verify a business, confirm the accessibility features the business claims to have (e.g., step-free entrance, accessible restroom, parking, etc).</li>
            <li>You must upload photos of these features as evidence. Clear, relevant photos help other users and support your report.</li>
            <li>Include details about entrances, toilets, parking, and other important features.</li>
            <li>Your verification will be reviewed by admins before being published.</li>
            <li>Verified reports help build a trusted, inclusive community and support others in finding accessible businesses.</li>
          </ul>
          <p>You can find businesses requesting verification, near you, by visiting the accessible business search page. Zoom in to your area on the map for more specific results.</p>
          <a href="{% url 'accessible_business_search' %}" class="btn btn-green">View Accessible Businesses</a>
        </div>
      </div>
    </div>
    {% endif %}

  </div>

</div>
{% endblock %}
