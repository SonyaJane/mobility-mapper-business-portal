{% extends "base.html" %}
{% load static account_extras %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/account_dashboard.css' %}">
{% endblock %}

{% block page_title %}Personal Dashboard{% endblock %}

{% block content %}
<div class="content-container p-1">

  <!-- Dashboard Header -->
  <div class="row align-items-center mt-2 mb-3 mt-md-4 mx-2 gy-4 gx-2 border rounded shadow-sm">
    <div class="p-0 m-0 col-md-6 text-center">
      {% if user.profile and user.profile.photo %}
      <img src="{{ profile_photo }}" alt="Profile Photo" class="img-fluid rounded my-4 profile-photo">
      {% else %}
      <img src="{% static 'images/profile_photo_placeholder.png' %}" alt="Profile Photo" class="img-fluid rounded my-4 profile-photo">
      {% endif %}
    </div>
    <div class="py-0 px-4 col-md-6 text-center">
      <h1 class="fw-bold">{{ user.first_name }} {{ user.last_name }}</h1>
      <p class="fs-5 text-muted">Dashboard</p>
    </div>
  </div>

  <div class="row mb-3 g-3">
    <!-- Profile Details Card -->
    <div class="col-md-8">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h2 class="card-title mb-3 h3">Profile Details</h2>
          <div class="table-responsive">
            <table id="profile-details" class="table table-sm table-striped table-hover mb-0">
              <tbody>
                <tr>
                  <td class="align-middle ps-3"><i class="bi bi-person-circle fs-5 me-2 text-mango"></i><strong>Username:</strong></td>
                  <td class="align-middle">{{ user.username }}</td>
                </tr>
                <tr>
                  <td class="align-middle ps-3"><i class="bi bi-envelope fs-5 me-2 text-orange"></i><strong>Email Address:</strong></td>
                  <td class="align-middle">{{ user.email }}</td>
                </tr>
                {% if user.profile and user.profile.county %}
                <tr>
                  <td class="align-middle ps-3"><i class="bi bi-geo-fill fs-5 me-2 text-brown"></i><strong>County:</strong></td>
                  <td class="align-middle">{{ user.profile.county }}</td>
                </tr>
                {% endif %}
                {% if user.profile and user.profile.age_group %}
                <tr>
                  <td class="align-middle ps-3"><i class="bi bi-person fs-5 me-2 text-mango"></i><strong>Age Group:</strong></td>
                  <td class="align-middle">{{ user.profile.age_group }}</td>
                </tr>
                {% endif %}
                <tr>
                  <td class="align-middle ps-3"><i class="bi bi-globe fs-5 me-2 text-coffee"></i><strong>Country:</strong></td>
                  <td class="align-middle">{{ user.profile.country }}</td>
                </tr>
                  {% if user.profile and user.profile.is_wheeler %}
                  <tr>
                    <td class="align-middle ps-3"><i class="bi bi-person-wheelchair fs-5 me-2 text-orange"></i><strong>Mobility Devices:</strong></td>
                    <td class="align-middle">
                      {% with labels=user.profile.mobility_devices|device_labels %}
                        {{ labels }}{% if user.profile.mobility_devices_other %}, {{ user.profile.mobility_devices_other }}{% endif %}
                      {% endwith %}
                    </td>
                  </tr>
                  {% endif %}
                  {% if user.profile and user.profile.has_business and user.profile.business %}
                  <tr>
                    <td class="align-middle ps-3"><i class="bi bi-building fs-5 me-2 text-brown"></i><strong>Your Business:</strong></td>
                    <td class="align-middle"><a href="{% url 'business_dashboard' %}" class="link-body-emphasis">{{ user.profile.business.business_name }}</a></td>
                  </tr>
                  {% endif %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Account Actions Card -->
    <div class="col-md-4">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h2 class="card-title mb-3 h3">Account Actions</h2>
          <div class="d-flex flex-column gap-2">
            <a href="{% url 'edit_profile' %}" class="btn btn-orange">Edit Profile</a>
            <a href="{% url 'account_change_password' %}" class="btn btn-mango">Change Password</a>
            {% if user.profile and user.profile.has_business and not user.profile.business %}
              <a href="{% url 'register_business' %}" class="btn btn-green">Register Your Business</a>
            {% endif %}
            {% if verification_reports or approved_businesses or pending_businesses %}
              <a href="{% url 'accessibility_verification_hub' %}" class="btn btn-coffee">Accessibility Verification Hub</a>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  {% if user.profile and user.profile.is_wheeler %}
  <div class="row mb-3 g-3">

    <!-- Businesses you are approved to verify -->
    {% with unverified_businesses=approved_businesses|dictsort:"id"|filter_unverified:business_verification_status %}
      {% if unverified_businesses %}
        <div class="col-12">
          <div class="card shadow-sm">
            <div class="card-body">
              <h2 class="card-title mb-3 h3">Businesses you have been approved to verify</h2>
              <ul class="list-group">
                {% for business in unverified_businesses %}
                <li class="list-group-item">
                    <div class="row align-items-center">

                      <div class="col-sm-8 ms-0 ps-0">
                        <h3 class="mb-1 business text-orange h4">{{ business.business_name }}</h3>
                        {% if business.categories.all %}
                            <div class="mb-0 category">{{ business.categories.all|join:", " }}</div>
                        {% endif %}
                        <div>
                          {{ business.street_address1 }}{% if business.street_address2 %}, {{ business.street_address2 }}{% endif %}, {{ business.town_or_city }}, {{ business.county }}, {{ business.postcode }}
                        </div>
                      </div>

                      <div class="col-sm-4 mt-2 mt-sm-0 ms-0 px-0">
                        <div class="d-flex flex-sm-column gap-2 justify-content-sm-end align-items-sm-end">
                          <a href="{% url 'wheeler_verification_form' business.id %}" class="btn btn-green btn-custom-width">Start Verification</a>
                          <a href="{% url 'business_detail' business.id %}" class="btn btn-brown btn-custom-width">View Business</a>
                        </div>
                      </div>
                  </div>  
                </li>
                {% endfor %}
              </ul>
            </div>
          </div>
        </div>
      {% endif %}
    {% endwith %}

    {% if pending_businesses %}
      <div class="col-12">
        <div class="card shadow-sm">
          <div class="card-body">
            <h2 class="card-title mb-3 h3">Businesses you have applied to verify</h2>
            <ul class="list-group">
              {% for business in pending_businesses %}
                <li class="list-group-item">
                  <div class="row align-items-center">
                    <div class="col-sm-8 ms-0 ps-0">
                      <h3 class="mb-1 business text-orange h4">
                        <a href="{% url 'business_detail' business.id %}" class="text-decoration-none text-orange">{{ business.business_name }}</a>
                      </h3>
                      {% if business.categories.all %}
                        <div class="mb-0 category">{{ business.categories.all|join:", " }}</div>
                      {% endif %}
                      <div>
                        {{ business.street_address1 }}{% if business.street_address2 %}, {{ business.street_address2 }}{% endif %}, {{ business.town_or_city }}, {{ business.county }}, {{ business.postcode }}
                      </div>
                    </div>
                    <div class="col-sm-4 mt-2 mt-sm-0 ms-0 px-0">
                      <div class="d-flex flex-sm-column gap-2 justify-content-sm-end align-items-sm-end">
                        <a href="{% url 'cancel_wheeler_verification_application' business.id %}" class="btn btn-orange btn-custom-width">Cancel Request</a>
                        <a href="{% url 'business_detail' business.id %}" class="btn btn-brown btn-custom-width">View Business</a>
                      </div>
                    </div>
                  </div>
                </li>
              {% endfor %}
            </ul>
            </div>
          </div>
        </div>
    {% endif %}


    <!-- Business Verification Instructions -->
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-body">
          <h2 class="card-title mb-3 h3">Wheeler Accessibility Verification</h2>
          <p class="mb-2">As a wheeler, you can help improve accessibility for everyone by verifying the accessibility features of businesses you visit. Your reports help other users find accessible places and encourage businesses to improve their facilities.</p>
          <ul class="mb-2">
            <li>For every report you verify, you will receive a <strong>Â£10 Amazon voucher</strong> as a thank you for your contribution.</li>
            <li>To verify a business, confirm the accessibility features the business claims to have (e.g., step-free entrance, accessible restroom, parking, etc).</li>
            <li>You must upload photos of these features as evidence. Clear, relevant photos help other users and support your report.</li>
            <li>Include details about entrances, toilets, parking, and other important features.</li>
            <li>Your verification will be reviewed by admins before being published.</li>
            <li>Verified reports help build a trusted, inclusive community and support others in finding accessible businesses.</li>
          </ul>
          <p>You can find businesses requesting verification, near you, by visiting the accessible business search page. Zoom in to your area on the map for more specific results.</p>
          <a href="{% url 'accessible_business_search' %}" class="btn btn-green">View Accessible Businesses</a>
        </div>
      </div>
    </div>
    {% endif %}

  </div>

</div>
{% endblock %}
